<?php
// filepath: c:\Users\HP\Desktop\DOCUMENTS\Soutenance\AppliStageConnect\Stageconnect\Pages\Profil.php

session_start();
require_once '../Models/config.php';

// V√©rifie que l'utilisateur est connect√© ET que son entit√© est bien "etudiant"
if (
    !isset($_SESSION['user_id']) 
) {
    header('Location: ../Auth/Login.php');
    exit();
}

// R√©cup√©rer les infos de l'utilisateur connect√©
$user_id = $_SESSION['user_id'];
$sql = "SELECT * FROM etudiants WHERE id = :id";
$stmt = $pdo->prepare($sql);
$stmt->execute([':id' => $user_id]);
$user = $stmt->fetch(PDO::FETCH_ASSOC);


// R√©cup√©rer les comp√©tences li√©es √† l'√©tudiant
$sql_comp = "SELECT nom_competence FROM competences WHERE etudiant_id = :id";
$stmt_comp = $pdo->prepare($sql_comp);
$stmt_comp->execute([':id' => $user_id]);
$competences = $stmt_comp->fetchAll(PDO::FETCH_COLUMN);

// R√©cup√©rer les formations li√©es √† l'√©tudiant
$sql_form = "SELECT diplome, ecole, date_obtention FROM formations WHERE etudiant_id = :id";
$stmt_form = $pdo->prepare($sql_form);
$stmt_form->execute([':id' => $user_id]);
$formations = $stmt_form->fetchAll(PDO::FETCH_ASSOC);

// R√©cup√©rer les exp√©riences li√©es √† l'√©tudiant
$sql_exp = "SELECT poste, entreprise, adresse, date_debut, date_fin, type_experience FROM experiences WHERE etudiant_id = :id";
$stmt_exp = $pdo->prepare($sql_exp);
$stmt_exp->execute([':id' => $user_id]);
$experiences = $stmt_exp->fetchAll(PDO::FETCH_ASSOC);
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
     <link rel="stylesheet" href="../Assets/Styles/Style.css">
  <link rel="stylesheet" href="../Assets/Styles/Style2.css">
  
 <title>StageConnect - Mon CV</title>
 
</head>
<body>


  <div class="body">

    <div class="Navbar">
           
            <div class="navbarContent">
                
                <div class="logo">
                    
                    <a href="index.php">
                        <img src="../Assets/Images/mascot.png" alt="logo" class='mascot'/>    
                    </a>
                    
                    <a href="index.php">
                        <img src="../Assets/Images/logoLg.png" alt="logo" class='logolg'/>    
                    </a>
                    
                    
                </div>

                <div class="SectionLinks">
                    <nav>
                        <a href="#Home">Acceuil</a>
                        <a href="#About">A propos</a>
                        <a href="#Features">Fonctionnalit√©s</a>
                        <a href="Entreprise.php">Espace entreprise</a>
                        <a href="Offer.php" class='offer'>Offres de stages<span>üî¥</span></a>
                    </nav>
                </div>

                 <div class="profil" id="profilMenu">
                    <div class="profil-content" onclick="toggleProfilPopup(event)">
                        <div class="userProfil">
                            <img src="" alt="">
                        </div>
                        <p class="UserName"><b>
                            <?php
                            if (isset($_SESSION['fullname'])) {
                                echo htmlspecialchars($_SESSION['fullname']);
                            } elseif (isset($_SESSION['BsName'])) {
                                echo htmlspecialchars($_SESSION['BsName']);
                            } else {
                                echo 'Utilisateur';
                            }
                            ?>
                        </b></p>

                        
                    </div>
                    <div class="profil-popup" id="profilPopup" style="display:none; display: flex;
                    flex-direction: column;">
                        
                        <?php
                            $profilLink = '#'; // valeur par d√©faut

                            if (isset($_SESSION['entity'])) {
                                if ($_SESSION['entity'] === 'etudiant') {
                                    $profilLink = './Profil.php';
                                } elseif ($_SESSION['entity'] === 'entreprise') {
                                    $profilLink = './dashboard_entreprise/static/pages-profile.php';
                                }
                            }
                            ?>
                        
                       
                        <a href="../Controllers/logout.php" class="logout-link">Se d√©connecter</a>
                    </div>
                </div>
            
            </div>

        </div>


        <div class="body_container">
            <div class="sideBar">
                <div class="backgroundImage"></div>
                <div class="photoProfil" style="background: url(../Assets/Images/etudiant.jpg) left/cover no-repeat; background-size: cover;"></div>
                <div class="infoProfil">
                    <h3><?php echo htmlspecialchars($user['nom_complet']); ?></h3>
                    <p><?php echo htmlspecialchars($user['filiere']); ?></p>
                </div>

               
                <hr>
                <div class="buttons">
                          <button><a href="Profil.php">Mon Profil</a></button>
                          <button><a href="OffrePost.php">Offre(s) Postul√©(s)</a></button>
                          <button class="active"><a href="myCv.html">Mon CV</a></button>
                    </div>

                    <div class="logOut">
                        <a href="../Controllers/logout.php" class="logout-link redColor">Se d√©connecter</a>
                    </div>
                     

            </div>

            
            <div class="container">
               
                <div class="cv-container" style="width: 90%; margin: auto; background: #fff; padding: 20px;">
  <h2 style="text-align: center; margin-bottom: 20px;">Mon CV</h2>
  
  <!-- Aper√ßu PDF -->
  <div id="cvPreview" style="border: 1px solid #ddd; border-radius: 10px; overflow: hidden; height: 500px;">
      <canvas id="pdfCanvas" style="width:100%;"></canvas>
  </div>

  <!-- Bouton pour consulter -->
  <div style="text-align:center; margin-top: 15px;">
      <a href="../CV/CVPro.pdf" target="_blank" 
         style="background:#2563eb; color:#fff; padding:10px 20px; border-radius:8px; text-decoration:none;">
         Consulter le CV complet
      </a>
  </div>
</div>
  
            </div>

        </div>


      <link rel="stylesheet" href="../Assets/CV/CVPro.pdf">


  </div>

  <!-- Librairie PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.12.313/pdf.worker.min.js"></script>
<script>
  // Indiquer √† PDF.js o√π trouver le worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.12.313/pdf.worker.min.js";

  const url = "../Assets/CV/CVPro.pdf"; // chemin vers ton CV

  const loadingTask = pdfjsLib.getDocument(url);
  loadingTask.promise.then(pdf => {
    pdf.getPage(1).then(page => {
      const scale = 1.3; // zoom
      const viewport = page.getViewport({ scale });
      const canvas = document.getElementById("pdfCanvas");
      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      page.render({ canvasContext: context, viewport });
    });
  }).catch(error => {
    console.error("Erreur PDF.js :", error);
  });
</script>

  <script>
// Ouvre le popup
document.getElementById('ajout_formation').onclick = function() {
    document.getElementById('popupFormation').style.display = 'flex';
};
document.getElementById('ajout_exp').onclick = function() {
    document.getElementById('popupExperience').style.display = 'flex';
};
// Ferme le popup
function closePopup(id) {
    document.getElementById(id).style.display = 'none';
}
// Fermer le popup si on clique en dehors du contenu
document.querySelectorAll('.popup-overlay').forEach(function(popup){
    popup.addEventListener('click', function(e){
        if(e.target === popup) popup.style.display = 'none';
    });
});
</script>

<style>
/* Popups */
.popup-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.popup-content {
    background: #fff;
    border-radius: 1.5vh;
    padding: 2em 2.5em;
    min-width: 320px;
    box-shadow: 0 4px 24px rgba(82,113,255,0.13);
    display: flex;
    flex-direction: column;
    gap: 1em;
}
.popup-content h3 {
    margin-top: 0;
    color: var(--blue, #526fff);
    text-align: center;
}
.popup-content input {
    padding: 0.7em 1em;
    border: 1px solid #dbeafe;
    border-radius: 1vh;
    font-size: 1em;
    background: #f8fafc;
}
.popup-actions {
    display: flex;
    gap: 1em;
    justify-content: flex-end;
}
</style>

 <script src="../Assets/Js/Features.js"></script>
        <script src="../Assets/Js/Offer_Features.js"></script>
</body>
</html>
